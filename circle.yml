machine:
  pre:
    - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0
  timezone:
    Europe/Berlin
  node:
    version: 4.2.6
  services:
    - docker

general:
  artifacts:
    - ./coverage

dependencies:
  pre:
    - git describe --tags > CURRENT_TAG
    - rm -rf node_modules
  override:
    - npm install
    - npm install -g codeclimate-test-reporter

test:
  pre:
  override:
    - >
      MOCHA_FILE=$CIRCLE_TEST_REPORTS/test-results.xml
      npm run test:cover
  post:
    - cp -R ./coverage $CIRCLE_ARTIFACTS
    - >
      CODECLIMATE_REPO_TOKEN=$CODECLIMATE_REPO_TOKEN
      codeclimate-test-reporter < ./coverage/lcov.info

deployment:
  release:
    tag: /release-.*/
    commands:
      - >
        SHOUTIT_ENV=live
        npm run build
      - pip install awscli
      - aws s3 sync public s3://shoutit-web-static/prod
      - >
        docker build
        --build-arg SHOUTIT_ENV=live
        -t shoutit/shoutit-web:live .
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - docker push shoutit/shoutit-web:live
  hub-master:
    branch: master
    commands:
      - >
        SHOUTIT_ENV=beta
        npm run build
      - pip install awscli
      - aws s3 sync public s3://shoutit-web-static/beta
      - >
        docker build
        --build-arg SHOUTIT_ENV=beta
        -t shoutit/shoutit-web:master .
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - docker push shoutit/shoutit-web:master
  hub-develop:
    branch: develop
    commands:
      - >
        SHOUTIT_ENV=stage
        npm run build
      - pip install awscli
      - aws s3 sync public s3://shoutit-web-static/stage
      - >
        docker build
        --build-arg SHOUTIT_ENV=stage
        -t shoutit/shoutit-web:develop .
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - docker push shoutit/shoutit-web:develop
