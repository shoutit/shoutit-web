machine:
  timezone:
    Europe/Berlin
  node:
    version: 4.2.2
  services:
    - docker

general:
  artifacts:
    - ./coverage

dependencies:
  override:
    - npm install
  post:
    - npm run build
    - docker info
    - docker build -t shoutit/shoutit-web:develop .

test:
  pre:
  override:
    - MOCHA_FILE=$CIRCLE_TEST_REPORTS/test-results.xml npm run test:cover
    - docker run -e SHOUTIT_BASE_URL=http:/localhost:8080 -e PORT=8080 -d -p 8080:8080 shoutit/shoutit-web:develop; sleep 10
    - curl --retry 10 --retry-delay 5 -v http://localhost:8080
  post:
    - cp -R ./coverage $CIRCLE_ARTIFACTS

deployment:
  hub-master:
    branch: master
    commands:
      - eval "$DEPLOY_MASTER"
  hub-develop:
    branch: develop
    commands:
      - docker build -t shoutit/shoutit-web:develop .
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - docker push shoutit/shoutit-web:develop
