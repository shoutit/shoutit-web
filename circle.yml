machine:
  timezone:
    Europe/Berlin
  node:
    version: 4.2.6
  services:
    - docker

general:
  artifacts:
    - ./coverage

dependencies:
  pre:
    - npm prune
  override:
    - npm install

test:
  pre:
  override:
    - >
      MOCHA_FILE=$CIRCLE_TEST_REPORTS/test-results.xml
      npm run test:cover
  post:
    - cp -R ./coverage $CIRCLE_ARTIFACTS

deployment:
  hub-master:
    branch: master
    commands:
      - SHOUTIT_PUBLIC_URL=$SHOUTIT_PUBLIC_URL_BETA npm run build
      - SHOUTIT_S3_BASEPATH=$SHOUTIT_S3_BASEPATH_BETA npm run build:upload
      - docker build -t -e SHOUTIT_PUBLIC_URL=$SHOUTIT_PUBLIC_URL_BETA shoutit/shoutit-web:master .
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - docker push shoutit/shoutit-web:master
  hub-develop:
    branch: develop
    commands:
      - >
        SHOUTIT_PUBLIC_URL=https://stage.web.static.shoutit.com
        npm run build
      - >
        SHOUTIT_S3_BASEPATH=stage
        npm run build:upload
      - docker build --build-arg SHOUTIT_PUBLIC_URL=https://stage.web.static.shoutit.com -t shoutit/shoutit-web:develop .
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - docker push shoutit/shoutit-web:develop
